From: https://github.com/codership/galera-bugs/commit/efbb60cda56ddd4f8149c8527ef75c15b2340be9.patch
From: Teemu Ollakka <teemu.ollakka@galeracluster.com>
Date: Thu, 4 Feb 2021 09:16:31 +0200
Subject: [PATCH] codership/galera#558 Check if libatomic is needed

--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -11,6 +11,7 @@ include(CheckCXXCompilerFlag)
 include(CheckIncludeFile)
 include(CheckIncludeFileCXX)
 include(CheckCXXCompilerFlag)
+include(CheckLibraryExists)
 
 include_directories(
   ${CMAKE_SOURCE_DIR}
--- a/cmake/os.cmake
+++ b/cmake/os.cmake
@@ -8,4 +8,18 @@ find_library(PTHREAD_LIB pthread)
 find_library(RT_LIB rt)
 set(GALERA_SYSTEM_LIBS ${PTHREAD_LIB} ${RT_LIB})
 
+# Check if linkage with atomic library is needed for 8 byte atomics
+set(ATOMIC_8_TEST_C_SOURCE
+  "int main() { long long val; __atomic_fetch_add_8(&val, 1, __ATOMIC_SEQ_CST); return 0;}")
+check_c_source_compiles("${ATOMIC_8_TEST_C_SOURCE}" GALERA_HAVE_ATOMIC)
+if (NOT GALERA_HAVE_ATOMIC)
+  find_library(ATOMIC_LIB NAMES atomic libatomic.so.1)
+  set(CMAKE_REQUIRED_LIBRARIES ${ATOMIC_LIB})
+  check_c_source_compiles("${ATOMIC_8_TEST_C_SOURCE}" GALERA_HAVE_ATOMIC_LIB)
+  if (NOT GALERA_HAVE_ATOMIC_LIB)
+    message(FATAL_ERROR "Could not find support for 64 bit atomic operations")
+  endif()
+  unset(CMAKE_REQUIRED_LIBRARIES)
+  list(APPEND GALERA_SYSTEM_LIBS ${ATOMIC_LIB})
+endif()
 message(STATUS "Galera system libs: ${GALERA_SYSTEM_LIBS}")
